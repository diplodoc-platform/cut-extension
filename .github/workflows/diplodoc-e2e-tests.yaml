name: Diplodoc E2E Tests

on:
  pull_request:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  # Parent repository settings (update if different)
  PARENT_OWNER: diplodoc-platform
  PARENT_REPO: diplodoc

jobs:
  trigger-parent-e2e:
    name: 'Test in Parent Context'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current branch name
        id: branch
        run: echo "name=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

      - name: Trigger and wait for parent E2E workflow
        id: trigger
        env:
          GH_TOKEN: ${{ secrets.PARENT_REPO_TOKEN }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
        run: |
          set -e

          PARENT_FULL="${{ env.PARENT_OWNER }}/${{ env.PARENT_REPO }}"
          REPO_NAME="${{ github.event.repository.name }}"
          TRIGGER_ID="${REPO_NAME}-${{ github.run_id }}"

          echo "ðŸŽ¯ Unique trigger ID: $TRIGGER_ID"

          TRIGGER_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          gh workflow run e2e-tests.yaml \
            --repo "$PARENT_FULL" \
            --ref master \
            --field submodules_override="$BRANCH_NAME" \
            --field trigger_id="$TRIGGER_ID"

          echo "â³ Waiting for workflow to start..."
          sleep 10

          # Find the workflow run by unique trigger ID
          # This is 100% reliable even when many workflows run simultaneously
          echo "ðŸ” Looking for workflow run with trigger ID: $TRIGGER_ID..."

          MAX_ATTEMPTS=18  # 18 attempts * 5 seconds = 90 seconds max wait
          ATTEMPT=0
          RUN_ID=""

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            # Search by trigger_id in displayTitle (100% reliable)
            # The parent workflow uses run-name to include trigger_id in displayTitle
            RUN_ID=$(gh run list \
              --repo "$PARENT_FULL" \
              --workflow=e2e-tests.yaml \
              --created ">=$TRIGGER_TIME" \
              --limit 20 \
              --json databaseId,status,displayTitle \
              --jq --arg trigger_id "$TRIGGER_ID" \
              'map(select(.status != "completed" and (.displayTitle | contains($trigger_id)))) | .[0].databaseId // empty')

            if [ -n "$RUN_ID" ]; then
              echo "âœ… Found workflow run by trigger ID in displayTitle"
              echo "   Run ID: $RUN_ID"
              break
            fi

            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "   Attempt $ATTEMPT/$MAX_ATTEMPTS - workflow not found yet, waiting..."
              sleep 5
            fi
          done

          if [ -z "$RUN_ID" ]; then
            echo "âŒ Failed to find workflow run after $MAX_ATTEMPTS attempts"
            echo "   Trigger ID: $TRIGGER_ID"
            echo "   This might mean the workflow didn't start or took too long to appear"
            exit 1
          fi

          echo "ðŸ“‹ Workflow run ID: $RUN_ID"
          echo "ðŸ”— https://github.com/$PARENT_FULL/actions/runs/$RUN_ID"

          # Save RUN_ID to outputs for use in Summary
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          echo ""
          echo "â³ Waiting for workflow to complete..."

          # Watch the workflow run and wait for completion
          # This command will exit with non-zero status if the workflow fails
          gh run watch "$RUN_ID" --repo "$PARENT_FULL" --exit-status

          echo ""
          echo "âœ… E2E tests completed successfully!"

      - name: Summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PARENT_REPO_TOKEN }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
          RUN_ID: ${{ steps.trigger.outputs.run_id }}
        run: |
          PARENT_FULL="${{ env.PARENT_OWNER }}/${{ env.PARENT_REPO }}"

          # Get the run info for our specific run ID (if available)
          if [ -n "$RUN_ID" ]; then
            echo "ðŸ“‹ Getting info for run ID: $RUN_ID"
            RUN_INFO=$(gh run view "$RUN_ID" \
              --repo "$PARENT_FULL" \
              --json conclusion,url \
              --jq '.')
          else
            echo "âš ï¸ Run ID not available, getting latest run"
            RUN_INFO=$(gh run list \
              --repo "$PARENT_FULL" \
              --workflow=e2e-tests.yaml \
              --limit 1 \
              --json conclusion,url \
              --jq '.[0]')
          fi

          CONCLUSION=$(echo "$RUN_INFO" | jq -r '.conclusion')
          RUN_URL=$(echo "$RUN_INFO" | jq -r '.url')

          echo "## E2E Test Results ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $CONCLUSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CONCLUSION" = "success" ]; then
            echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
          elif [ "$CONCLUSION" = "failure" ]; then
            echo "âŒ Tests failed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Tests completed with status: $CONCLUSION" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View detailed results â†’]($RUN_URL)" >> $GITHUB_STEP_SUMMARY
